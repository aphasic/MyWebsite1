<% include ../include/header %>    	
    <link rel="stylesheet" href="/stylesheets/webuploader.css">
    <style>          
        .small{
            font-size: 13px;
        }
        .span-margin-left{
            margin-left: 10px;
        }
        .span-margin-right{
            margin-right: 10px;
        }
        .img-cover{
            width: 100%;
            height: auto;
        }
        .album-intro {
            color:rgba(12, 5, 19, 0.48);
            display: -webkit-box;
            text-overflow:ellipsis;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            -moz-box-orient: vertical;
            -ms-box-orient: vertical;
            box-orient: vertical;
            overflow: hidden;
        }

        .cover-wrap{
            height: 210px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .intro-wrap{
            height: 70px;
        }
        .main #content_menu a{
            display: block;
            width: 100px;
            height: 100px;
            margin: 0 30px;
            overflow: hidden;
        }
        .main #content_menu .nomal-menu{
            /*				display: none;*/
            display: block;
        }
        .main #content_menu .batch-menu{
            /*position: fixed;
            top: 200px;
            left: 420px;
            z-index: 5;*/
            display: none;
        }
        .main #content_menu h4{
           /* margin: 10px;*/
            display: inline-block;
        }
        .main #content_menu img{
            width: 100px;
            height: auto;
        }
        .main #content_menu span{
            padding: 0 5px;
        }
        .main #content_menu .line{
            border-right: 1px solid #ccc;
        }
        section{
            margin: 20px 0;
        }
        #content_photoes{
            position: relative;
            padding-top: 30px;
        }
        #content_photoes h4{
            text-align: center;
        }
        #content_photoes h4 span{
            position: relative;
        }
        #content_photoes h4 span::before,#content_photoes h4 span::after{
            content: "";
            display: block;
            height: 1px;
            width: 50px;
            background: #efefef;
            position: absolute;
            top: 50%;
        }
        #content_photoes h4 span::before{
            left: -60px;
        }
        #content_photoes h4 span::after{
            right: -60px;
        }
        #content_photoes .photoes-list{
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #content_photoes .photoes-list .photoes-item{
            width: 18%;
            list-style: none;
            float: left;
            margin: 1%;
            position: relative;
        }
        #content_photoes .photoes-list .photoes-item a{
            display: block;
            width: 100%;
            height: 80%;
            overflow: hidden;
            
        }
         #content_photoes .photoes-list .photoes-item .photo-picture{
            border: 1px solid #efefef;
         }
        #content_photoes .photoes-list .photoes-item .photo-name{
            width: 100%;
            height: 20%;
            padding-top: 5px;
            overflow: hidden;
            padding-left: 5px;
            border: 1px solid #efefef;
        }


        #content_photoes .photoes-list .photoes-item:hover .photo-cover{
            display: block;
        }
        #content_photoes .photoes-list .photoes-item img{
            width: 100%;
            height: auto;
        }
        #content_photoes .photoes-list .photoes-item .photo-cover{
            width: 100%;
            padding: 5%;
            padding-bottom: 20px;
            position: absolute;
            color: #fff;
            line-height: 17px;
            left: 0;
            bottom: 20%;
            background: rgba(1,1,1,0.5);
            display: none;
        }
        .photo-cover .option-item a{
            display: block;
            width: 100%;

        }
        .photo-cover .option-item a::before{
            width: 200%;
            height: 18px;
            text-align: center;
            position: absolute;
            color: #efefef;
            bottom: -20px;
            left: -50%;
            display: none;
            font-size: 12px;
        }
        .photo-cover .option-item:nth-child(1) a::before{
            content: "编辑";
        }
        .photo-cover .option-item:nth-child(2) a::before{
            content: "设为封面";
        }
        .photo-cover .option-item:nth-child(3) a::before{
            content: "移动到相册";
        }
        .photo-cover .option-item:nth-child(4) a::before{
            content: "删除";
        }
        .photo-cover .option-item a:hover::before{
            display: block;
        }
        #content_photoes .photoes-list .photoes-item .check-box{
            width: 22px;
            height: 22px;
            position: absolute;
            right: 1px;
            top: 1px;
            display: none;
        }
        .check-box-nomal{
            background: #fff;
            border: 1px solid #ccc;
        }
        .check-box-checked{
            background: url(/images/test/timg.jpg);
            background-size: 100% 100%;
        }
        .control-number{
            color: #ccc;
        }
        .active-number{
            color: #ff601a;
        }
        #set_cover{
            width: 200px;
            height: 50px;
            background: #fff;
            border: 1px solid #ccc;
            position: fixed;
            top: 50%;
            left: 50%;
            margin-left: -100px;
            margin-top: -25px;
        }
        #set_cover p{
            line-height: 50px;
            margin-left: 25px;
        }
        /*			控制设置封面的效果*/
        #set_cover{
            display: none;
        }
        #set_cover .wait{
            display: none;
        }
        #set_cover .set-success{
            display: none;
        }
        #set_cover .wait .wait-circle{
            width: 40px;
            height: 40px;
            margin: 5px;
            margin-left: 25px;
            float: left;
            position: relative;
        }
        #set_cover .wait .wait-circle i{
            width: 2px;
            height: 11px;
            position: absolute;
            left: 19px;
            top: 0;
            background: #ccc;
            -webkit-transform-origin: 1px 20px;
            -moz-transform-origin: 1px 20px;
            -ms-transform-origin: 1px 20px;
            -o-transform-origin: 1px 20px;
            transform-origin: 1px 20px;
        }
        #set_cover .wait .wait-circle i:nth-child(2){
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            -o-transform: rotate(45deg);
            transform: rotate(45deg);
        }
        #set_cover .wait .wait-circle i:nth-child(3){
            -webkit-transform: rotate(90deg);
            -ms-transform: rotate(90deg);
            -o-transform: rotate(90deg);
            transform: rotate(90deg);
        }
        #set_cover .wait .wait-circle i:nth-child(4){
            -webkit-transform: rotate(135deg);
            -ms-transform: rotate(135deg);
            -o-transform: rotate(135deg);
            transform: rotate(135deg);
        }
        #set_cover .wait .wait-circle i:nth-child(5){
            -webkit-transform: rotate(180deg);
            -ms-transform: rotate(180deg);
            -o-transform: rotate(180deg);
            transform: rotate(180deg);
        }
        #set_cover .wait .wait-circle i:nth-child(6){
            -webkit-transform: rotate(225deg);
            -ms-transform: rotate(225deg);
            -o-transform: rotate(225deg);
            transform: rotate(225deg);
        }
        #set_cover .wait .wait-circle i:nth-child(7){
            -webkit-transform: rotate(270deg);
            -ms-transform: rotate(270deg);
            -o-transform: rotate(270deg);
            transform: rotate(270deg);
        }
        #set_cover .wait .wait-circle i:nth-child(8){
            -webkit-transform: rotate(315deg);
            -ms-transform: rotate(315deg);
            -o-transform: rotate(315deg);
            transform: rotate(315deg);
        }
        #set_cover .brand{
            width: 20px;
            height: 20px;
            margin: 15px;
            margin-left: 25px;
            float: left;
        }
        #set_cover .brand span{
            font-size: 20px;
        }
    </style>
</head>
<body>						
	<% include ../include/nav_menu %>
    <div>
        <div class="main">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <%= albuminfo.name %>
                    </div>
                    <div class="panel-body">
                        <section id="content_menu">
                            <div class="media">
                                <a href="" class="pull-left">
                                    <% if(typeof albuminfo.cover == 'undefined'){ %>
                                        <img id="album-cover" src="/album/pic-none.png" alt="...">
                                    <% }else{ %>
                                        <img id="album-cover" src="/<%=albuminfo.cover%>" alt="...">
                                    <% } %>
                                </a>
                                <div class="media-body">
                                    <h4 class="media-heading"><%= albuminfo.name %></h4>
                                    <span class="text-muted line"><%= photolist.length %> 张</span>
                                    <% if(2 == albuminfo.access){ %>
                                        <span class="text-muted">私密相册</span>
                                    <% } else if(3 == albuminfo.access){ %>
                                        <span class="text-muted">密码访问</span>
                                    <% } else { %>
                                        <span class="text-muted">公开相册</span>
                                    <% } %>
                                    <p><%= albuminfo.description %></p>
                                    <div class="nomal-menu">
                                        <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#uploadphotos"><span class="glyphicon glyphicon-circle-arrow-up"></span> 上传照片</button>
                                        <button id="btn_batch" class="btn btn-default btn-sm">批量管理</button>
                                        <button class="btn btn-default btn-sm btn-editalbum"  data-name="<%=albuminfo.name %>" data-description="<%=albuminfo.description %>" data-id="<%=albuminfo._id%>" data-access="<%=albuminfo.access%>" data-accesspwd="<%=albuminfo.accesspwd%>" data-toggle="modal" data-target="#editalbum">相册编辑</button>
                                        <button class="btn btn-default btn-sm btn-deletealbum" data-name="<%=albuminfo.name%>" data-id="<%=albuminfo._id%>" data-toggle="modal" data-target="#deletealbum">删除相册</button>
                                    </div>
                                    <div class="batch-menu">
                                        <button id="check_all" class="btn btn-default btn-sm">
                                            <span class="glyphicon glyphicon-ok-sign span-margin-right"></span>全选
                                        </button>
                                        <button class="btn btn-default btn-sm" data-toggle="modal" data-target="#editphotoes">
                                            <span class="glyphicon glyphicon-edit span-margin-right"></span>编辑信息
                                        </button>
                                        <button class="btn btn-default btn-sm" data-toggle="modal" data-target="#movephotoes">
                                            <span class="glyphicon glyphicon-move span-margin-right"></span>移动到相册
                                        </button>
                                        <button class="btn btn-default btn-sm" data-toggle="modal" data-target="#deletephotoes">
                                            <span class="glyphicon glyphicon-trash span-margin-right"></span>删除图片
                                        </button>
                                        <button id="finish_batch" class="btn btn-info btn-sm">
                                            完成管理
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <section id="content_photoes">
                            <div class="row">
                                <div class="col-sm-12">                                   
                                   <!--  <div class="col-sm-12"><h4><span>2017/2/25</span></h4></div> -->
                                    <ul class="photoes-list">
                                        <% photolist.forEach(function(item){ %>
                                            <li class="photoes-item">
                                                <a target="_blank" href="/<%=item.path%>" class="photo-picture">
                                                    <img src="/<%= item.thumbnail %>" alt="">
                                                </a>
                                                <div class="photo-cover small">
                                                    <p></p>
                                                    <div class="photo-cover-menu">
                                                        <div class="col-sm-3 option-item"><a href="javascript:;" data-photoid="<%=item._id %>" data-toggle="modal" data-target="#editphotoes"><span class="glyphicon glyphicon-edit"> </span></a></div>
                                                        <div class="col-sm-3 option-item"><a href="javascript:;" class="set-cover" data-filepath="<%=item.thumbnail%>" data-albumid="<%=albuminfo._id%>"><span class="glyphicon glyphicon-tag"> </span></a></div>
                                                        <div class="col-sm-3 option-item"><a href="javascript:;" class="btn-movesingle" data-toggle="modal" data-target="#movephotoes"><span class="glyphicon glyphicon-move"> </span></a></div>
                                                        <div class="col-sm-3 option-item"><a href="javascript:;" class="btn-deletesingle" data-toggle="modal" data-target="#deletephotoes"><span class="glyphicon glyphicon-trash"> </span></a></div>
                                                    </div>
                                                </div>
                                                <i class="check-box check-box-nomal checkbox-photos" data-photoid=<%=item.id%>></i>
                                                <p class="photo-name"><%= moment(item.meta.updateAt).format('YY-MM-DD HH:mm:ss') %>
                                                    <span class="span-margin-left"></span>
                                                </p>
                                            </li>
                                        <% }) %>                               
                                    </ul>                                                          
                                </div>
                            </div>
                        </section>

                    </div>
                </div>
            </div>
        </div><!--main-->
    </div>
    <% include uploadphotos %>
    <% include editphoto %>
    <% include movephotos %>
    <% include deletephotos %>
    <% include editalbum %>
    <% include deletealbum %>
    <% include setcover %>
    <% include uploadphotos %>

	<script src="/javascripts/jquery2.1.4.min.js"></script>
	<script src="/javascripts/bootstrap.min.js"></script>	
	<script src="/javascripts/webuploader.min.js"></script>
	<script src="/javascripts/uploadphotos.js"></script>
    <script>
        $(function(){
            //设置图片高度
            (function(){
                var width_ = $(".photoes-list li").width();
                $(".photoes-list li").height(width_ + "px");
                $(window).resize(function(){
                    var width_ = $(".photoes-list li").width();
                    $(".photoes-list li").height(width_ + "px");
                });
            })();
            //对控制字数的表单进行实时监控字数变化
            (function(){
                var inputs = $("input[maxlength],textarea[maxlength]");
                $(inputs).bind("input propertychange",function(){
                    var active_number = $(this).next("span").find(".active-number");
                    var maxlength = $(this).attr("maxlength");
                    var length = this.value.length;
                    $(active_number).html(length);
                    if(length>maxlength){
                        this.value = this.value.substring(0,maxlength);
                    }
                });
            })();
            //movephotoes模态框中的点击事件
            (function(){
                var lis = $("#album_wrap .list-group-item");
                $(lis).bind("click",function(){
                    $(this).addClass('toalbum-checked').siblings().removeClass('toalbum-checked');
                    $(this).find('span').css({'color':'rgb(66,139,202)'});
                    $(this).siblings().children('span').css({'color':'rgb(85, 85, 85)'});
                });
            })();
            //设置wait处圆圈的颜色变化
            (function(){
                var is = $("#set_cover .wait-circle i");
                var flag = 0;
                $(is[flag]).css("background","#333");
                setInterval(function(){
                    $(is).css("background","#ccc");
                    flag++;
                    if(flag == 8){
                        flag = 0;
                    }
                    $(is[flag]).css("background","#333");
                },100);
            })();
            //批量管理的点击事件
            (function(){
                $("#btn_batch").on("click",function(){
                    $("#content_photoes .check-box").show();
                    $("#content_photoes .photo-cover-menu").hide();
                    $(".nomal-menu").hide();
                    $(".batch-menu").show();
                    $(".photoes-item a").on("click",function(){
                        return false;
                    });
                });
                $("#finish_batch").on("click",function(){
                    $("#content_photoes .check-box").hide();
                    $("#content_photoes .photo-cover-menu").show();
                    $(".nomal-menu").show();
                    $(".batch-menu").hide();
                    $(".photoes-item a").unbind("click");
                })
                $(".check-box").on("click",function(){
                    if($(this).hasClass("check-box-nomal")){
                        $(this).removeClass("check-box-nomal").addClass("check-box-checked");
                    }
                    else{
                        $(this).removeClass("check-box-checked").addClass("check-box-nomal");
                    }
                });
                $("#check_all").on("click",function(){
                    if($(".check-box").hasClass("check-box-nomal")){
                        $(".check-box").removeClass("check-box-nomal").addClass("check-box-checked");
                    }
                    else{
                        $(".check-box").removeClass("check-box-checked").addClass("check-box-nomal");
                    }
                })

            })();
            //设置封面
            $('.set-cover').click(function(){   
                var filepath = $(this).data('filepath');
                var albumid = $(this).data('albumid');
                $.post('/admin/album/setcover',{'filepath':filepath, 'albumid':albumid},
                    function(err){
                        if(err){
                            alert('设置封面失败');
                        }else{
                            $('#album-cover').attr('src', '/'+filepath);
                            var coverDom = $('#set_cover,#set_cover .set-success');
                            coverDom.css({
                                'display' : 'block'
                            });
                            setTimeout(function(){
                               coverDom.css({
                                    'display' : 'none'
                                }); 
                            },2000)
                        }
                    })
            });

            //获取选中的checkbox
            function getCheckId(){
                var checkedPhotos = $('.check-box-checked');
                var photosArr = [];
                checkedPhotos.map(function(n){
                    photosArr.push($(checkedPhotos[n]).data('photoid'));
                })
                return photosArr;
            }
            //移动照片
            $('#btn-movephotos').on('click',function(){
                var photosArr = getCheckId();
                var toAlbumid = $(".toalbum-checked").data('albumid');
                if(!toAlbumid){
                    alert('请选择移动到的相册！');
                    return false;
                } else if(!photosArr.length) {
                    alert('请先选择照片！');
                    return false;
                } else {
                    $.post('/admin/album/movephotos',{'albumid':toAlbumid,'photos':JSON.stringify(photosArr)},
                        function(err){
                            if(err){
                                alert('移动照片失败');
                            } else {
                                location.reload();
                            }
                        })
                }
            });
            $('.btn-movesingle, .btn-deletesingle').click(function(){
                $(this).parents('.photoes-item').find('i').removeClass("check-box-nomal").addClass("check-box-checked");
            });
            //删除照片
            $('#btn-deletephotos').click(function(){
                var photosArr = getCheckId();
                if(!photosArr.length) {
                    alert('请先选择照片！');
                    return false;
                } else {
                    $.post('/admin/album/deletephotos',{'photos':JSON.stringify(photosArr)},
                        function(err) {
                            if(err) {
                                alert('删除照片失败');
                            } else {
                                location.reload();
                            }
                        })
                }
            })          
        });

        //编辑相册信息，代码暂时冗余，稍后修改
        $('.btn-editalbum').on('click', function(){
            $('#text-albumname').attr('value', $(this).data('name'));
            $('#text-description').html($(this).data('description'));
            var access = $(this).data('access');
            $("#form-editalbum input[name='access']").eq(access-1).attr('checked',true);
            var input_accesspwd = $("input[name='accesspwd']");
            if(3 == access){
                input_accesspwd.attr('value', $(this).data('accesspwd'));
            }else{
                input_accesspwd.attr('value','');
            }
            $('#form-editalbum').append('<input type="hidden" name="albumid" value="' + $(this).data('id') + '" />');
        })
        //删除相册
        $('.btn-deletealbum').on('click', function(){
            $('#delete-album-name').html($(this).data('name'));
            console.log($(this).data('name'));
            var form_deletealbum = $('#form-deletealbum');
            form_deletealbum.empty();
            form_deletealbum.append('<input type="hidden" name="albumid" value="' + $(this).data('id') + '" />');
        })

    </script>
</body>
</html>